
/**
 * @fileoverview Firestore Security Rules for SnipQueue.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for customer data and
 * restricts barber and service data management to administrators. Barbers can
 * manage their own data. Public read access is granted for barbers, services, and schedules.
 *
 * Data Structure:
 * - /customers/{customerId}: Customer profiles.
 * - /barbers/{barberId}: Barber profiles.
 * - /services/{serviceId}: Service information.
 * - /schedules/{scheduleId}: Barber schedules, linked by barberId field.
 * - /appointments/{appointmentId}: All appointments, linked by customerId and barberId.
 * - /shopSettings/{settingId}: Global shop settings like hours.
 * - /pageContent/{pageId}: Editable content for website pages.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      // In a real app, this would check for a custom claim: request.auth.token.isAdmin == true
      return request.auth != null && (request.auth.token.email == 'admin@example.com' || request.auth.token.email == 'iamsongyee@gmail.com');
    }

    function isBarber(barberId) {
      // A barber is identified by their UID matching the barberId.
      return isOwner(barberId);
    }
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Customer data can be read/written by the owner or an admin.
    match /customers/{customerId} {
      allow get, update, delete: if isOwner(customerId) || isAdmin();
      allow create: if isSignedIn();
      allow list: if isAdmin();
    }
    
    // Barbers profiles are public, but can only be written to by admins or the barber themselves.
    match /barbers/{barberId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin() || isBarber(barberId);
    }

    // Barber schedules are publicly readable. They can be managed by the assigned barber or an admin.
    match /schedules/{scheduleId} {
        allow get, list: if true;
        // On create, check the barberId in the incoming data.
        allow create: if isAdmin() || (request.resource.data.barberId != null && isBarber(request.resource.data.barberId));
        // On update/delete, check the barberId in the existing data.
        allow update, delete: if isAdmin() || (resource.data.barberId != null && isBarber(resource.data.barberId));
    }

    // Services are publicly readable, admin-only write.
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Appointments are in a top-level collection.
    match /appointments/{appointmentId} {
      // Allow read if user is owner, assigned barber, or admin.
      allow get: if isOwner(resource.data.customerId) || isBarber(resource.data.barberId) || isAdmin();

      // Allow list ONLY for admins (unfiltered).
      // Regular users MUST query by their customerId or barberId, which is enforced at the query level in the client.
      allow list: if isAdmin();
      
      // Allow create if the customerId in the new document matches the user's UID.
      allow create: if isOwner(request.resource.data.customerId) || isAdmin();
      
      // Allow update/delete if user is owner or admin. Barbers can also update status (e.g. to complete)
      allow update, delete: if isOwner(resource.data.customerId) || isAdmin() || isBarber(resource.data.barberId);
    }

    // Shop settings are publicly readable, but only writable by admins.
    match /shopSettings/{settingId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }

    // Page content is publicly readable, but only writable by admins.
    match /pageContent/{pageId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}
