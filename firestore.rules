
/**
 * @fileoverview Firestore Security Rules for SnipQueue.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for customer data and
 * restricts barber and service data management to administrators. Barbers can
 * manage their own data. Public read access is granted for barbers and services.
 *
 * Data Structure:
 * - /customers/{customerId}: Customer profiles.
 * - /barbers/{barberId}: Barber profiles. BarberId can match the authenticated user's UID.
 * - /services/{serviceId}: Service information.
 * - /customers/{customerId}/appointments/{appointmentId}: Appointments.
 * - /barbers/{barberId}/schedules/{scheduleId}: Barber schedules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      // In a real app, this would check for a custom claim: request.auth.token.isAdmin == true
      return request.auth != null && request.auth.token.email == 'admin@example.com';
    }

    function isBarber(barberId) {
      // A barber is identified by their UID matching the document ID in the barbers collection.
      return isOwner(barberId);
    }
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Customer data can be read/written by the owner or an admin.
    match /customers/{customerId} {
      allow get, list, create, update, delete: if isOwner(customerId) || isAdmin();

      // Appointments can be managed by the customer who owns them, the barber assigned to them, or an admin.
      match /appointments/{appointmentId} {
        allow get: if isOwner(customerId) || isAdmin() || isBarber(resource.data.barberId);
        allow list: if isOwner(customerId) || isAdmin();
        allow create: if isOwner(customerId) || isAdmin();
        allow update, delete: if isOwner(customerId) || isAdmin() || isBarber(resource.data.barberId);
      }
    }
    
    // Barbers profiles are public, but can only be written to by admins or the barber themselves.
    match /barbers/{barberId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin() || isBarber(barberId);

      // Barber schedules can be managed by the barber or an admin.
      match /schedules/{scheduleId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin() || isBarber(barberId);
      }
    }

    // Services are publicly readable, admin-only write.
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}
